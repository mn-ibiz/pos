<UserControl x:Class="HospitalityPOS.WPF.Views.CommissionManagementView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1400"
             Background="#1E1E2E">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter" />
    </UserControl.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button Content="Back"
                    Command="{Binding GoBackCommand}"
                    Background="#3D3D5C"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="16,12"
                    FontSize="14"
                    Cursor="Hand"/>

            <TextBlock Grid.Column="1"
                       Text="Commission Management"
                       FontSize="28"
                       FontWeight="SemiBold"
                       Foreground="White"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"/>

            <StackPanel Grid.Column="2" Orientation="Horizontal">
                <Button Content="+ New Rule"
                        Command="{Binding CreateNewRuleCommand}"
                        Background="#4F46E5"
                        Foreground="White"
                        BorderThickness="0"
                        Padding="24,12"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Cursor="Hand"
                        Margin="0,0,8,0"/>
                <Button Content="Export"
                        Command="{Binding ExportReportCommand}"
                        Background="#059669"
                        Foreground="White"
                        BorderThickness="0"
                        Padding="24,12"
                        FontSize="14"
                        Cursor="Hand"/>
            </StackPanel>
        </Grid>

        <!-- Summary Cards -->
        <Grid Grid.Row="1" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Background="#2D2D44" CornerRadius="8" Padding="16" Margin="0,0,8,0">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="Total Earned" Foreground="#9CA3AF" FontSize="12" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalCommissionEarned, StringFormat='KSh {0:N0}'}"
                               FontSize="24" FontWeight="Bold" Foreground="#4CAF50" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <Border Grid.Column="1" Background="#2D2D44" CornerRadius="8" Padding="16" Margin="4,0">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="Total Paid" Foreground="#9CA3AF" FontSize="12" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalCommissionPaid, StringFormat='KSh {0:N0}'}"
                               FontSize="24" FontWeight="Bold" Foreground="#2196F3" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <Border Grid.Column="2" Background="#2D2D44" CornerRadius="8" Padding="16" Margin="4,0">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="Pending" Foreground="#9CA3AF" FontSize="12" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding PendingCommission, StringFormat='KSh {0:N0}'}"
                               FontSize="24" FontWeight="Bold" Foreground="#FF9800" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>

            <Border Grid.Column="3" Background="#2D2D44" CornerRadius="8" Padding="16" Margin="8,0,0,0">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="Active Rules" Foreground="#9CA3AF" FontSize="12" HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding ActiveRulesCount}"
                               FontSize="24" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Tab Control -->
        <TabControl Grid.Row="2"
                    SelectedIndex="{Binding SelectedTabIndex}"
                    Background="Transparent"
                    BorderThickness="0">
            <TabControl.Resources>
                <Style TargetType="TabItem">
                    <Setter Property="Background" Value="#2D2D44"/>
                    <Setter Property="Foreground" Value="#9CA3AF"/>
                    <Setter Property="Padding" Value="20,12"/>
                    <Setter Property="FontSize" Value="14"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="TabItem">
                                <Border Name="Border" Background="#2D2D44" CornerRadius="8,8,0,0" Margin="0,0,4,0">
                                    <ContentPresenter x:Name="ContentSite"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      ContentSource="Header"
                                                      Margin="20,12"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="#4F46E5"/>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </TabControl.Resources>

            <!-- Commission Rules Tab -->
            <TabItem Header="Commission Rules">
                <Border Background="#2D2D44" CornerRadius="0,8,8,8">
                    <DataGrid ItemsSource="{Binding CommissionRules}"
                              SelectedItem="{Binding SelectedRule}"
                              AutoGenerateColumns="False"
                              Background="Transparent"
                              Foreground="White"
                              BorderThickness="0"
                              GridLinesVisibility="Horizontal"
                              HorizontalGridLinesBrush="#3D3D5C"
                              RowBackground="#2D2D44"
                              AlternatingRowBackground="#353550"
                              SelectionMode="Single"
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              RowHeight="48"
                              Margin="16">
                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="#3D3D5C"/>
                                <Setter Property="Foreground" Value="#AAAACC"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Padding" Value="16,12"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                        </DataGrid.ColumnHeaderStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Type" Binding="{Binding RuleType}" Width="100"/>
                            <DataGridTextColumn Header="Rate" Binding="{Binding CommissionRate, StringFormat='{}{0}%'}" Width="80"/>
                            <DataGridTextColumn Header="Method" Binding="{Binding CalculationMethod}" Width="100"/>
                            <DataGridTextColumn Header="Priority" Binding="{Binding Priority}" Width="80"/>
                            <DataGridTemplateColumn Header="Actions" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit"
                                                    Command="{Binding DataContext.EditRuleCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#4F46E5"
                                                    Foreground="White"
                                                    BorderThickness="0"
                                                    Padding="12,6"
                                                    Margin="0,0,4,0"
                                                    Cursor="Hand"/>
                                            <Button Content="Deactivate"
                                                    Command="{Binding DataContext.DeactivateRuleCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#DC2626"
                                                    Foreground="White"
                                                    BorderThickness="0"
                                                    Padding="12,6"
                                                    Cursor="Hand"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
            </TabItem>

            <!-- Employee Commissions Tab -->
            <TabItem Header="Employee Commissions">
                <Border Background="#2D2D44" CornerRadius="0,8,8,8">
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Date Filter -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <TextBlock Text="From:" Foreground="#9CA3AF" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <DatePicker SelectedDate="{Binding StartDate, Mode=TwoWay}"
                                        Background="#3D3D5C" Foreground="White" Width="150"/>
                            <TextBlock Text="To:" Foreground="#9CA3AF" VerticalAlignment="Center" Margin="16,0,8,0"/>
                            <DatePicker SelectedDate="{Binding EndDate, Mode=TwoWay}"
                                        Background="#3D3D5C" Foreground="White" Width="150"/>
                            <Button Content="Refresh"
                                    Command="{Binding LoadDataCommand}"
                                    Background="#4F46E5"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Padding="16,8"
                                    Margin="16,0,0,0"
                                    Cursor="Hand"/>
                        </StackPanel>

                        <DataGrid Grid.Row="1"
                                  ItemsSource="{Binding EmployeeSummaries}"
                                  SelectedItem="{Binding SelectedEmployee}"
                                  AutoGenerateColumns="False"
                                  Background="Transparent"
                                  Foreground="White"
                                  BorderThickness="0"
                                  GridLinesVisibility="Horizontal"
                                  HorizontalGridLinesBrush="#3D3D5C"
                                  RowBackground="#2D2D44"
                                  AlternatingRowBackground="#353550"
                                  SelectionMode="Single"
                                  CanUserAddRows="False"
                                  IsReadOnly="True"
                                  RowHeight="48">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="#3D3D5C"/>
                                    <Setter Property="Foreground" Value="#AAAACC"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Padding" Value="16,12"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Employee" Binding="{Binding EmployeeName}" Width="*"/>
                                <DataGridTextColumn Header="Role" Binding="{Binding Role}" Width="120"/>
                                <DataGridTextColumn Header="Sales" Binding="{Binding TotalSales}" Width="80"/>
                                <DataGridTextColumn Header="Sales Amount" Binding="{Binding TotalSalesAmount, StringFormat='KSh {0:N0}'}" Width="120"/>
                                <DataGridTextColumn Header="Commission" Binding="{Binding NetCommission, StringFormat='KSh {0:N0}'}" Width="120"/>
                                <DataGridTextColumn Header="Avg Rate" Binding="{Binding AverageCommissionRate, StringFormat='{}{0:N1}%'}" Width="80"/>
                                <DataGridTemplateColumn Header="Actions" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="Details"
                                                    Command="{Binding DataContext.ViewEmployeeDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#4F46E5"
                                                    Foreground="White"
                                                    BorderThickness="0"
                                                    Padding="12,6"
                                                    Cursor="Hand"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>
            </TabItem>

            <!-- Pending Payouts Tab -->
            <TabItem Header="Pending Payouts">
                <Border Background="#2D2D44" CornerRadius="0,8,8,8">
                    <DataGrid ItemsSource="{Binding PendingPayouts}"
                              SelectedItem="{Binding SelectedPayout}"
                              AutoGenerateColumns="False"
                              Background="Transparent"
                              Foreground="White"
                              BorderThickness="0"
                              GridLinesVisibility="Horizontal"
                              HorizontalGridLinesBrush="#3D3D5C"
                              RowBackground="#2D2D44"
                              AlternatingRowBackground="#353550"
                              SelectionMode="Single"
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              RowHeight="48"
                              Margin="16">
                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="#3D3D5C"/>
                                <Setter Property="Foreground" Value="#AAAACC"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Padding" Value="16,12"/>
                                <Setter Property="BorderThickness" Value="0"/>
                            </Style>
                        </DataGrid.ColumnHeaderStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Employee" Binding="{Binding EmployeeName}" Width="*"/>
                            <DataGridTextColumn Header="Period" Binding="{Binding PeriodStart, StringFormat='{}{0:MMM yyyy}'}" Width="100"/>
                            <DataGridTextColumn Header="Gross" Binding="{Binding GrossCommission, StringFormat='KSh {0:N0}'}" Width="120"/>
                            <DataGridTextColumn Header="Adjustments" Binding="{Binding Adjustments, StringFormat='KSh {0:N0}'}" Width="100"/>
                            <DataGridTextColumn Header="Net Payout" Binding="{Binding NetPayout, StringFormat='KSh {0:N0}'}" Width="120"/>
                            <DataGridTemplateColumn Header="Status" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="4" Padding="8,4">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#FF9800"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="Approved">
                                                            <Setter Property="Background" Value="#4CAF50"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Paid">
                                                            <Setter Property="Background" Value="#2196F3"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Status}" Foreground="White" FontSize="12" HorizontalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="180">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Approve"
                                                    Command="{Binding DataContext.ApprovePayoutCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#059669"
                                                    Foreground="White"
                                                    BorderThickness="0"
                                                    Padding="12,6"
                                                    Margin="0,0,4,0"
                                                    Cursor="Hand"
                                                    Visibility="{Binding Status, Converter={StaticResource BoolToVisConverter}}"/>
                                            <Button Content="Mark Paid"
                                                    Command="{Binding DataContext.MarkPayoutPaidCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Background="#4F46E5"
                                                    Foreground="White"
                                                    BorderThickness="0"
                                                    Padding="12,6"
                                                    Cursor="Hand"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
            </TabItem>

            <!-- Settings Tab -->
            <TabItem Header="Settings">
                <Border Background="#2D2D44" CornerRadius="0,8,8,8" Padding="24">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel MaxWidth="600">
                            <TextBlock Text="Commission Settings" FontSize="18" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,24"/>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Default Commission %" Foreground="#9CA3AF" Margin="0,0,0,8"/>
                                <TextBox Text="{Binding Settings.DefaultCommissionPercent}"
                                         Background="#3D3D5C" Foreground="White" Padding="12" BorderThickness="0"/>
                            </StackPanel>

                            <CheckBox Content="Enable Tiered Commission"
                                      IsChecked="{Binding Settings.EnableTieredCommission}"
                                      Foreground="White" Margin="0,0,0,16"/>

                            <CheckBox Content="Enable Split Commissions"
                                      IsChecked="{Binding Settings.EnableSplitCommissions}"
                                      Foreground="White" Margin="0,0,0,16"/>

                            <CheckBox Content="Calculate on Gross Amount (before discounts)"
                                      IsChecked="{Binding Settings.CalculateOnGrossAmount}"
                                      Foreground="White" Margin="0,0,0,16"/>

                            <CheckBox Content="Include Tax in Calculation"
                                      IsChecked="{Binding Settings.IncludeTaxInCalculation}"
                                      Foreground="White" Margin="0,0,0,16"/>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Minimum Sale Amount for Commission" Foreground="#9CA3AF" Margin="0,0,0,8"/>
                                <TextBox Text="{Binding Settings.MinimumSaleAmount}"
                                         Background="#3D3D5C" Foreground="White" Padding="12" BorderThickness="0"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Payout Frequency" Foreground="#9CA3AF" Margin="0,0,0,8"/>
                                <ComboBox SelectedItem="{Binding Settings.PayoutFrequency}"
                                          Background="#3D3D5C" Foreground="White" Padding="12">
                                    <ComboBoxItem Content="Weekly"/>
                                    <ComboBoxItem Content="BiWeekly"/>
                                    <ComboBoxItem Content="Monthly"/>
                                </ComboBox>
                            </StackPanel>

                            <StackPanel Margin="0,0,0,16">
                                <TextBlock Text="Confirmation Period (days)" Foreground="#9CA3AF" Margin="0,0,0,8"/>
                                <TextBox Text="{Binding Settings.ConfirmationPeriodDays}"
                                         Background="#3D3D5C" Foreground="White" Padding="12" BorderThickness="0"/>
                            </StackPanel>

                            <CheckBox Content="Require Manager Approval for Payouts"
                                      IsChecked="{Binding Settings.RequireApprovalForPayout}"
                                      Foreground="White" Margin="0,0,0,24"/>

                            <Button Content="Save Settings"
                                    Command="{Binding SaveSettingsCommand}"
                                    Background="#4F46E5"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Padding="24,12"
                                    FontSize="14"
                                    HorizontalAlignment="Left"
                                    Cursor="Hand"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </TabItem>
        </TabControl>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}"
                Panel.ZIndex="100">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="150" Height="4" Foreground="#4F46E5"/>
                <TextBlock Text="Loading..." Foreground="White" FontSize="14" Margin="0,12,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
