<UserControl x:Class="HospitalityPOS.WPF.Views.ReorderRulesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:HospitalityPOS.WPF.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="#1E1E2E">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter" />
    </UserControl.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0"
                    Content="Back"
                    Command="{Binding GoBackCommand}"
                    Background="#3D3D5C"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="16,12"
                    FontSize="14"
                    Cursor="Hand" />

            <TextBlock Grid.Column="1"
                       Text="Reorder Rules Configuration"
                       FontSize="28"
                       FontWeight="SemiBold"
                       Foreground="White"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center" />

            <Button Grid.Column="2"
                    Content="Create Bulk Rules"
                    Command="{Binding CreateBulkRulesCommand}"
                    Background="#FF9800"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="16,12"
                    FontSize="14"
                    Cursor="Hand"
                    Margin="0,0,12,0" />

            <Button Grid.Column="3"
                    Content="+ New Rule"
                    Command="{Binding CreateRuleCommand}"
                    Background="#4CAF50"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="24,12"
                    FontSize="16"
                    FontWeight="SemiBold"
                    Cursor="Hand" />
        </Grid>

        <!-- Filters -->
        <Border Grid.Row="1" Background="#2D2D44" CornerRadius="8" Padding="16" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Background="#3D3D5C"
                         Foreground="White"
                         BorderThickness="0"
                         Padding="12,8"
                         FontSize="14"
                         VerticalContentAlignment="Center">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Tag" Value="Search products..." />
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <ComboBox Grid.Column="1"
                          ItemsSource="{Binding Categories}"
                          SelectedItem="{Binding SelectedCategoryFilter}"
                          DisplayMemberPath="Name"
                          Background="#3D3D5C"
                          Foreground="White"
                          BorderThickness="0"
                          Padding="12,8"
                          Margin="12,0,0,0"
                          MinWidth="150" />

                <CheckBox Grid.Column="2"
                          Content="Show Only Enabled"
                          IsChecked="{Binding ShowOnlyEnabled}"
                          Foreground="White"
                          Margin="16,0,0,0"
                          VerticalAlignment="Center" />

                <Button Grid.Column="3"
                        Content="Clear Filters"
                        Command="{Binding ClearFiltersCommand}"
                        Background="#3D3D5C"
                        Foreground="White"
                        BorderThickness="0"
                        Padding="12,8"
                        Margin="12,0,0,0"
                        Cursor="Hand" />
            </Grid>
        </Border>

        <!-- Main Content - Split View -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Rules List -->
            <Border Grid.Column="0" Background="#2D2D44" CornerRadius="8" Padding="16">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Reorder Rules" FontSize="16" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,12" />

                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding ReorderRules}"
                              SelectedItem="{Binding SelectedRule}"
                              AutoGenerateColumns="False"
                              Background="Transparent"
                              BorderThickness="0"
                              RowBackground="#3D3D5C"
                              AlternatingRowBackground="#353550"
                              Foreground="White"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              SelectionMode="Single"
                              IsReadOnly="True"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Product" Binding="{Binding Product.Name}" Width="*" />
                            <DataGridTextColumn Header="SKU" Binding="{Binding Product.SKU}" Width="100" />
                            <DataGridTextColumn Header="Reorder Point" Binding="{Binding ReorderPoint, StringFormat=N0}" Width="100" />
                            <DataGridTextColumn Header="Reorder Qty" Binding="{Binding ReorderQuantity, StringFormat=N0}" Width="100" />
                            <DataGridTextColumn Header="Lead Time" Binding="{Binding LeadTimeDays}" Width="80" />
                            <DataGridTextColumn Header="Supplier" Binding="{Binding PreferredSupplier.Name}" Width="150" />
                            <DataGridCheckBoxColumn Header="Auto" Binding="{Binding IsAutoReorderEnabled}" Width="50" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <!-- Edit Panel (shown when editing) -->
            <Border Grid.Column="1"
                    Background="#2D2D44"
                    CornerRadius="8"
                    Padding="16"
                    Margin="16,0,0,0"
                    Width="400"
                    Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="{Binding EditingRule.Id, StringFormat='Edit Rule #{0}', TargetNullValue='New Rule'}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   Margin="0,0,0,16" />

                        <!-- Product Selection -->
                        <TextBlock Text="Product" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <ComboBox ItemsSource="{Binding Products}"
                                  SelectedItem="{Binding SelectedProduct}"
                                  DisplayMemberPath="Name"
                                  Background="#3D3D5C"
                                  Foreground="White"
                                  BorderThickness="0"
                                  Padding="12,8"
                                  Margin="0,0,0,12" />

                        <!-- Reorder Point -->
                        <TextBlock Text="Reorder Point" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.ReorderPoint}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Reorder Quantity -->
                        <TextBlock Text="Reorder Quantity" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.ReorderQuantity}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Max Stock Level -->
                        <TextBlock Text="Max Stock Level (Optional)" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.MaxStockLevel}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Safety Stock -->
                        <TextBlock Text="Safety Stock" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.SafetyStock}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Lead Time -->
                        <TextBlock Text="Lead Time (Days)" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.LeadTimeDays}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Preferred Supplier -->
                        <TextBlock Text="Preferred Supplier" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <ComboBox ItemsSource="{Binding Suppliers}"
                                  SelectedItem="{Binding SelectedSupplier}"
                                  DisplayMemberPath="Name"
                                  Background="#3D3D5C"
                                  Foreground="White"
                                  BorderThickness="0"
                                  Padding="12,8"
                                  Margin="0,0,0,12" />

                        <!-- Min Order Quantity -->
                        <TextBlock Text="Min Order Quantity (Optional)" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.MinOrderQuantity}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Order Multiple -->
                        <TextBlock Text="Order Multiple (Optional)" Foreground="#8888AA" FontSize="12" Margin="0,0,0,4" />
                        <TextBox Text="{Binding EditingRule.OrderMultiple}"
                                 Background="#3D3D5C"
                                 Foreground="White"
                                 BorderThickness="0"
                                 Padding="12,8"
                                 Margin="0,0,0,12" />

                        <!-- Auto Reorder Enabled -->
                        <CheckBox Content="Enable Auto-Reorder"
                                  IsChecked="{Binding EditingRule.IsAutoReorderEnabled}"
                                  Foreground="White"
                                  Margin="0,0,0,8" />

                        <!-- Consolidate Reorders -->
                        <CheckBox Content="Consolidate with Other Items"
                                  IsChecked="{Binding EditingRule.ConsolidateReorders}"
                                  Foreground="White"
                                  Margin="0,0,0,16" />

                        <!-- EOQ Calculation -->
                        <Button Content="Calculate EOQ"
                                Command="{Binding CalculateEOQCommand}"
                                Background="#2196F3"
                                Foreground="White"
                                BorderThickness="0"
                                Padding="12,8"
                                Margin="0,0,0,16"
                                Cursor="Hand" />

                        <!-- Action Buttons -->
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0"
                                    Content="Cancel"
                                    Command="{Binding CancelEditCommand}"
                                    Background="#3D3D5C"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Padding="12,10"
                                    Margin="0,0,6,0"
                                    Cursor="Hand" />

                            <Button Grid.Column="1"
                                    Content="Save"
                                    Command="{Binding SaveRuleCommand}"
                                    Background="#4CAF50"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Padding="12,10"
                                    Margin="6,0,0,0"
                                    Cursor="Hand" />
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Action Panel (shown when not editing) -->
            <Border Grid.Column="1"
                    Background="#2D2D44"
                    CornerRadius="8"
                    Padding="16"
                    Margin="16,0,0,0"
                    Width="200">
                <Border.Visibility>
                    <Binding Path="IsEditing" Converter="{StaticResource BoolToVisConverter}">
                        <Binding.ConverterParameter>Inverse</Binding.ConverterParameter>
                    </Binding>
                </Border.Visibility>
                <StackPanel>
                    <TextBlock Text="Actions"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="White"
                               Margin="0,0,0,16" />

                    <Button Content="Edit Rule"
                            Command="{Binding EditRuleCommand}"
                            Background="#2196F3"
                            Foreground="White"
                            BorderThickness="0"
                            Padding="12,10"
                            Margin="0,0,0,8"
                            Cursor="Hand" />

                    <Button Content="Toggle Auto-Reorder"
                            Command="{Binding ToggleAutoReorderCommand}"
                            Background="#FF9800"
                            Foreground="White"
                            BorderThickness="0"
                            Padding="12,10"
                            Margin="0,0,0,8"
                            Cursor="Hand" />

                    <Button Content="Delete Rule"
                            Command="{Binding DeleteRuleCommand}"
                            Background="#F44336"
                            Foreground="White"
                            BorderThickness="0"
                            Padding="12,10"
                            Cursor="Hand" />
                </StackPanel>
            </Border>
        </Grid>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="Loading..."
                           FontSize="18"
                           Foreground="White"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
