## Overview

Implement a comprehensive Z Report (End-of-Day) system with automated generation capabilities. Z Reports are critical fiscal documents that serve as official accounting records and must be retained for tax compliance (6+ years per HMRC guidelines).

## Background Research

### What is a Z Report?
- **Definition**: An end-of-day report generated at the close of a trading day
- **Function**: Shows grand totals, summarizes till actions (sales, refunds, payment methods), and **resets the day's activities** so a new trading day begins fresh
- **Fiscal Importance**: The Z report is the **key daily sales report for accounting** and serves as a **tax-compliant document**
- **Finality**: Once generated, a Z report **cannot be modified** - all sales within that period are final

### Z Report vs X Report
| Feature | X Report | Z Report |
|---------|----------|----------|
| Timing | Anytime during trading | End of shift/day |
| Resets Data | No | Yes |
| Tax Compliant | No | **Yes** |
| Can be modified | Yes | **No** |
| Accounting Use | Internal review only | **Official record** |

## Current State Analysis

The codebase has existing infrastructure:
- `ZReport` DTO exists in `HospitalityPOS.Core/DTOs/Reports/SalesReports.cs`
- `WorkPeriod` entity with opening/closing cash reconciliation
- `Receipt`, `Payment`, `Order` entities for sales data
- `IFinancialReportingService` interface for report generation

## Requirements

### 1. Z Report Data Structure

```
REPORT HEADER
├── Store Information (ID, Name, Address, Tax ID)
├── Register/Terminal Number
├── Work Period ID
├── Shift Number
├── Report Date/Time
├── Shift Start/End Times
├── Generated By (User ID, Name)

SALES SUMMARY
├── Gross Sales (before discounts/voids)
├── Net Sales (after discounts/voids)
├── Returns/Refunds Amount
├── Voids Amount
├── Discounts Amount
├── Tax Collected (by tax type)
├── Tips Collected
├── Rounding Adjustments

DEPARTMENT/CATEGORY BREAKDOWN
├── Sales by Category
│   ├── Category Name
│   ├── Quantity Sold
│   ├── Gross Amount
│   └── Net Amount
└── Sales by Product (optional detail level)

PAYMENT BREAKDOWN
├── Cash
│   ├── Opening Float
│   ├── Cash Sales
│   ├── Cash Refunds
│   ├── Pay-ins
│   ├── Pay-outs
│   ├── Expected Cash
│   └── Actual Cash (counted)
├── Card Payments (by type)
├── M-Pesa/Mobile Payments
├── Bank Transfers
├── Credit Sales
└── Other Payment Methods

CASH DRAWER RECONCILIATION
├── Opening Amount
├── Total Cash Received
├── Total Cash Paid Out
├── Expected Closing Amount
├── Actual Counted Amount
├── Variance (Over/Short)
└── Variance Explanation (if any)

TRANSACTION STATISTICS
├── Number of Transactions
├── Number of Customers
├── Average Transaction Value
├── Number of Voids
├── Number of Refunds
├── Number of Discounts Applied
├── Open Drawer Count

USER/SERVER SUMMARY
├── Sales by User
│   ├── User Name
│   ├── Transaction Count
│   ├── Gross Sales
│   └── Net Sales
└── Tips by User

HOURLY BREAKDOWN
├── Sales by Hour
│   ├── Hour
│   ├── Transaction Count
│   └── Sales Amount
└── Peak Hours Identification

REPORT FOOTER
├── Report Generation Timestamp
├── Sequential Z Report Number (for audit trail)
├── Digital Signature/Hash (for integrity)
└── Batch Number (if applicable)
```

### 2. Core Features

#### 2.1 Manual Z Report Generation
- [ ] Generate Z report from POS interface
- [ ] Pre-generation validation (all orders closed, cash counted)
- [ ] Preview mode before finalizing
- [ ] Confirmation dialog with warning about finality
- [ ] Generate unique sequential report number

#### 2.2 Automated Z Report Generation
- [ ] Scheduled generation at configurable time (e.g., 2:00 AM daily)
- [ ] Auto-close work periods with warning if still open
- [ ] Email/notification before auto-generation
- [ ] Configurable auto-generation rules:
  - After X hours of inactivity
  - At specific time
  - When cash drawer is closed and counted

#### 2.3 Multi-Terminal Consolidation
- [ ] Individual terminal Z reports
- [ ] Consolidated Z report across all terminals
- [ ] Store-level consolidation
- [ ] Chain-level consolidation (multi-store)

#### 2.4 Report Storage & Retrieval
- [ ] Store Z reports immutably in database
- [ ] Searchable by date range, store, terminal
- [ ] Export to PDF, Excel, CSV
- [ ] Print to receipt printer
- [ ] Email distribution

#### 2.5 Batch/Settlement Integration
- [ ] Close payment card batch when Z report generated
- [ ] Settlement confirmation before Z report finalization
- [ ] Track batch numbers in Z report

### 3. Database Schema Changes

```csharp
public class ZReportRecord : BaseEntity
{
    public int ReportNumber { get; set; } // Sequential, unique
    public int StoreId { get; set; }
    public int? TerminalId { get; set; }
    public int WorkPeriodId { get; set; }
    public DateTime ReportDateTime { get; set; }
    public DateTime PeriodStartDateTime { get; set; }
    public DateTime PeriodEndDateTime { get; set; }
    public int GeneratedByUserId { get; set; }

    // Sales Summary
    public decimal GrossSales { get; set; }
    public decimal NetSales { get; set; }
    public decimal TotalRefunds { get; set; }
    public decimal TotalVoids { get; set; }
    public decimal TotalDiscounts { get; set; }
    public decimal TotalTax { get; set; }
    public decimal TotalTips { get; set; }

    // Cash Reconciliation
    public decimal OpeningCash { get; set; }
    public decimal ExpectedCash { get; set; }
    public decimal ActualCash { get; set; }
    public decimal CashVariance { get; set; }
    public string VarianceExplanation { get; set; }

    // Statistics
    public int TransactionCount { get; set; }
    public int CustomerCount { get; set; }
    public decimal AverageTransactionValue { get; set; }
    public int VoidCount { get; set; }
    public int RefundCount { get; set; }

    // Integrity
    public string ReportHash { get; set; }
    public bool IsFinalized { get; set; }

    // Full report data (JSON)
    public string ReportDataJson { get; set; }

    // Navigation
    public virtual Store Store { get; set; }
    public virtual WorkPeriod WorkPeriod { get; set; }
    public virtual User GeneratedByUser { get; set; }
    public virtual ICollection<ZReportCategorySales> CategorySales { get; set; }
    public virtual ICollection<ZReportPaymentSummary> PaymentSummaries { get; set; }
    public virtual ICollection<ZReportHourlySales> HourlySales { get; set; }
    public virtual ICollection<ZReportUserSales> UserSales { get; set; }
}

public class ZReportCategorySales : BaseEntity
{
    public int ZReportRecordId { get; set; }
    public int CategoryId { get; set; }
    public string CategoryName { get; set; }
    public int QuantitySold { get; set; }
    public decimal GrossAmount { get; set; }
    public decimal NetAmount { get; set; }
}

public class ZReportPaymentSummary : BaseEntity
{
    public int ZReportRecordId { get; set; }
    public int PaymentMethodId { get; set; }
    public string PaymentMethodName { get; set; }
    public int TransactionCount { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal RefundAmount { get; set; }
    public decimal NetAmount { get; set; }
}

public class ZReportSchedule : BaseEntity
{
    public int StoreId { get; set; }
    public TimeSpan ScheduledTime { get; set; }
    public bool IsEnabled { get; set; }
    public bool SendEmailNotification { get; set; }
    public string NotificationEmails { get; set; }
    public int MinutesWarningBefore { get; set; }
    public bool AutoCloseWorkPeriod { get; set; }
}
```

### 4. Service Interface

```csharp
public interface IZReportService
{
    // Generation
    Task<ZReportPreview> PreviewZReportAsync(int workPeriodId, CancellationToken ct = default);
    Task<ZReportRecord> GenerateZReportAsync(int workPeriodId, decimal actualCashCounted, string varianceExplanation = null, CancellationToken ct = default);
    Task<ZReportRecord> GenerateConsolidatedZReportAsync(int storeId, DateTime reportDate, CancellationToken ct = default);

    // Retrieval
    Task<ZReportRecord> GetZReportAsync(int reportId, CancellationToken ct = default);
    Task<IEnumerable<ZReportRecord>> GetZReportsAsync(ZReportFilterDto filter, CancellationToken ct = default);
    Task<ZReportRecord> GetZReportByNumberAsync(int reportNumber, int storeId, CancellationToken ct = default);

    // Export
    Task<byte[]> ExportToPdfAsync(int reportId, CancellationToken ct = default);
    Task<byte[]> ExportToExcelAsync(int reportId, CancellationToken ct = default);
    Task PrintZReportAsync(int reportId, int printerId, CancellationToken ct = default);
    Task EmailZReportAsync(int reportId, string[] recipients, CancellationToken ct = default);

    // Scheduling
    Task<ZReportSchedule> GetScheduleAsync(int storeId, CancellationToken ct = default);
    Task<ZReportSchedule> UpdateScheduleAsync(int storeId, ZReportScheduleDto schedule, CancellationToken ct = default);
    Task TriggerScheduledZReportsAsync(CancellationToken ct = default);

    // Validation
    Task<ZReportValidationResult> ValidateCanGenerateAsync(int workPeriodId, CancellationToken ct = default);
}
```

### 5. UI Components

#### 5.1 Z Report Generation View
- Work period selection
- Cash count entry form
- Variance explanation (if over/short)
- Preview panel showing report summary
- Generate & Print button
- Generate & Email button

#### 5.2 Z Report History View
- Date range filter
- Store/Terminal filter
- Grid view with key metrics
- Detail view on selection
- Export options

#### 5.3 Z Report Schedule Settings
- Enable/disable auto-generation
- Time picker for scheduled time
- Email recipients configuration
- Warning notification settings

### 6. Business Rules

1. **Cannot generate Z report if:**
   - Work period is not open
   - There are unsettled receipts
   - Cash has not been counted
   - Previous Z report pending for same terminal

2. **Z Report Finalization:**
   - Report becomes immutable once generated
   - Hash is computed for integrity verification
   - Sequential number is assigned
   - Work period is marked as closed

3. **Variance Handling:**
   - Variances over configurable threshold require explanation
   - Large variances trigger manager approval workflow
   - All variances logged for audit

4. **Retention:**
   - Z reports retained for minimum 6 years
   - Cannot be deleted (only archived)
   - Audit trail for all access

## Acceptance Criteria

- [ ] Z report can be generated manually from POS with all required data
- [ ] Z report preview shows accurate calculations before finalization
- [ ] Generated Z reports are immutable and have integrity hash
- [ ] Sequential report numbering with no gaps
- [ ] Cash reconciliation variance is calculated and displayed
- [ ] Reports can be exported to PDF/Excel
- [ ] Reports can be printed to receipt printer
- [ ] Automated scheduling generates reports at configured time
- [ ] Multi-terminal consolidation produces accurate totals
- [ ] Historical Z reports are searchable and retrievable
- [ ] X report (interim) works independently without resetting data

## Implementation Notes

### Existing Code to Leverage
- `WorkPeriod` entity and `IWorkPeriodService` for period management
- `Receipt` and `Payment` entities for transaction data
- `IFinancialReportingService` patterns for report generation
- `SavedReport` and `ReportExecutionLog` for scheduling infrastructure

### Integration Points
- Close work period when Z report generated
- Post summary journal entry to accounting (if accounting module active)
- Trigger batch settlement for card payments
- Update cash drawer status

## References

- [Mobile Transaction - X vs Z Report](https://www.mobiletransaction.org/what-is-an-x-vs-z-report/)
- [KORONA POS - End of Day Statement](https://manual.koronapos.com/finish-day-end-of-day-statement/)
- [HMRC VAT Traders Records](https://www.gov.uk/guidance/record-keeping-for-vat-registered-businesses) - 6-year retention requirement

---

**Priority**: High
**Estimated Complexity**: Large
**Labels**: feature, reporting, compliance, accounting
